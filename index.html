<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ£’çƒä¸»é¡Œæ‹ç«‹å¾—ç›¸æ¡†ï½œå…å¾Œç«¯</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#11172b; --accent:#f7f7fb; --primary:#4da3ff; --ok:#27c93f; --warn:#ffbd2e; --danger:#ff5f56;
    }
    *{box-sizing:border-box;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--accent); background:linear-gradient(180deg,#0b1020,#0e1733 40%,#0b1020);}    
    .wrap{max-width:1200px; margin:0 auto; padding:20px;}
    header{display:flex; align-items:center; gap:12px; padding:10px 0 18px;}
    .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(circle at 30% 30%,#fff, #ffdede 60%, #f4b5b5 70%);position:relative;box-shadow:0 2px 10px rgba(0,0,0,.35)}
    .logo:before,.logo:after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(135deg, #c72d2d 0 2px, transparent 2px 6px);clip-path:polygon(10% 0, 15% 0, 85% 100%, 80% 100%);opacity:.4}
    .logo:after{transform:scaleX(-1);}
    h1{font-size:22px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 420px; gap:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .panel{padding:14px;}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    button, .ghost{
      appearance:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06);
      color:var(--accent); padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; backdrop-filter: blur(8px);
    }
    button:hover{background:rgba(255,255,255,.12)}
    button.primary{border-color:transparent; background:linear-gradient(135deg,#5198ff,#7cb0ff)}
    button.ok{border-color:transparent; background:linear-gradient(135deg,#2fd66f,#60e391)}
    button.warn{border-color:transparent; background:linear-gradient(135deg,#ffbe2e,#ffd35c)}
    button.danger{border-color:transparent; background:linear-gradient(135deg,#ff5f56,#ff877f)}
    .row{display:flex;gap:10px;align-items:center}
    .hint{font-size:13px;opacity:.75}
    .stage{position:relative; border-radius:16px; overflow:hidden; aspect-ratio: 4 / 3; background:#000}
    video{width:100%; height:100%; object-fit:cover; display:block;}
    canvas{max-width:100%; background:#000; border-radius:16px}
    .overlay{position:absolute; inset:0; pointer-events:none}
    .frameSVG{width:100%; height:100%;}
    .badge{position:absolute; top:10px; left:10px; background:rgba(0,0,0,.5); padding:6px 10px; border-radius:999px; font-size:12px}
    .stickers{display:flex; gap:8px; flex-wrap:wrap}
    .sticker{width:48px; height:48px; border-radius:12px; background:rgba(255,255,255,.08); display:grid; place-items:center; user-select:none; cursor:grab}
    .canvasWrap{position:relative}
    .draggable{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); cursor:move;}
    .ghost{opacity:.7}
    .side{display:flex; flex-direction:column; gap:12px;}
    .footer{opacity:.7; font-size:13px; text-align:center; padding:12px}
    .toggle{display:inline-flex; align-items:center; gap:6px}
    input[type=range]{width:140px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>æ£’çƒä¸»é¡Œæ‹ç«‹å¾—ç›¸æ¡†ï¼ˆå…å¾Œç«¯ HTML+JSï¼‰</h1>
    </header>

    <div class="grid">
      <!-- å·¦ï¼šå–æ™¯ï¼è¼¸å‡ºå€ -->
      <section class="card panel">
        <div class="toolbar">
          <button id="btnStart" class="primary">å•Ÿå‹•é¡é ­</button>
          <button id="btnSwitch">åˆ‡æ›å‰ï¼å¾Œé¡é ­</button>
          <label class="toggle"><input type="checkbox" id="chkMirror" checked> é¡åƒé è¦½</label>
          <label class="toggle"><input type="checkbox" id="chkCountdown"> 3 ç§’å€’æ•¸</label>
          <label class="toggle">ç›¸æ¡†ä¸é€æ˜åº¦ <input id="frameOpacity" type="range" min="40" max="100" value="92"></label>
          <span class="hint">æç¤ºï¼šéœ€ HTTPS æˆ–æœ¬æ©Ÿæ‰èƒ½é–‹å•Ÿé¡é ­</span>
        </div>

        <div class="stage" id="stage">
          <video id="video" playsinline muted></video>
          <div class="overlay" id="overlay">
            <!-- æ‹ç«‹å¾—é¢¨æ ¼ + æ£’çƒç¸«ç·šçš„ç›¸æ¡†ï¼ˆSVGï¼Œå¯æ”¹è‰²ï¼‰ -->
            <svg class="frameSVG" viewBox="0 0 1200 900" xmlns="http://www.w3.org/2000/svg">
              <!-- æ‹ç«‹å¾—å¤–æ¡† -->
              <defs>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                  <feDropShadow dx="0" dy="14" stdDeviation="12" flood-color="#000" flood-opacity="0.35"/>
                </filter>
              </defs>
              <rect x="80" y="40" rx="28" ry="28" width="1040" height="820" fill="white" opacity="0.95" filter="url(#shadow)"/>
              <!-- å…§éƒ¨å–æ™¯çª— -->
              <rect x="130" y="90" rx="18" ry="18" width="940" height="640" fill="transparent" stroke="#e7e7e7" stroke-width="6" />
              <!-- ä¸‹æ–¹ç™½é‚Šçš„æ´»å‹•æ¨™é¡Œå€ -->
              <g>
                <rect x="130" y="750" width="940" height="70" fill="#ffffff" opacity="0.95"/>
                <text x="600" y="795" text-anchor="middle" font-family="'Segoe UI', 'Noto Sans TC', sans-serif" font-size="40" fill="#1b2a4b" font-weight="700">TAIWAN BASEBALL NIGHT</text>
              </g>

              <!-- å·¦å³å…©å´æ£’çƒç¸«ç·šè£é£¾ -->
              <g stroke="#d23a3a" stroke-width="8" stroke-linecap="round">
                <!-- å·¦ -->
                <path d="M120,120 C180,260 180,560 120,700" fill="none"/>
                <g>
                  <path d="M150,180 l40,-18"/>
                  <path d="M150,230 l40,-18"/>
                  <path d="M150,280 l40,-18"/>
                  <path d="M150,330 l40,-18"/>
                  <path d="M150,380 l40,-18"/>
                  <path d="M150,430 l40,-18"/>
                  <path d="M150,480 l40,-18"/>
                  <path d="M150,530 l40,-18"/>
                  <path d="M150,580 l40,-18"/>
                  <path d="M150,630 l40,-18"/>
                </g>
                <!-- å³ -->
                <path d="M1080,120 C1020,260 1020,560 1080,700" fill="none"/>
                <g>
                  <path d="M1050,180 l-40,-18"/>
                  <path d="M1050,230 l-40,-18"/>
                  <path d="M1050,280 l-40,-18"/>
                  <path d="M1050,330 l-40,-18"/>
                  <path d="M1050,380 l-40,-18"/>
                  <path d="M1050,430 l-40,-18"/>
                  <path d="M1050,480 l-40,-18"/>
                  <path d="M1050,530 l-40,-18"/>
                  <path d="M1050,580 l-40,-18"/>
                  <path d="M1050,630 l-40,-18"/>
                </g>
              </g>

              <!-- å³ä¸‹è§’éšŠå¾½ï¼ˆTï¼‰ -->
              <g transform="translate(980,760)">
                <circle r="28" fill="#0b1020"/>
                <text x="0" y="10" text-anchor="middle" font-family="'Segoe UI', 'Noto Sans TC', sans-serif" font-size="40" fill="#ffffff" font-weight="900">T</text>
              </g>
            </svg>
            <div class="badge" id="badge">LIVEâ€†â€¢â€†00:00</div>
          </div>
        </div>

        <div class="toolbar" style="margin-top:12px">
          <button id="btnSnap" class="ok">æ‹ç…§</button>
          <button id="btnRetake" class="ghost hidden">é‡æ‹</button>
          <button id="btnDownload" class="warn hidden">ä¸‹è¼‰ç…§ç‰‡</button>
          <span class="hint">å¯æ‹–æ›³è²¼åœ–åˆ°ç•«é¢ï¼›æ‹ç…§å¾Œä»å¯ç§»å‹•è²¼åœ–å†ä¸‹è¼‰ã€‚</span>
        </div>

        <div class="canvasWrap">
          <canvas id="canvas" class="hidden"></canvas>
          <!-- æ‹ç…§å®Œæˆå¾Œï¼ŒæŠŠå¯æ‹–æ›³è²¼åœ–æ”¾åœ¨é€™ä¸€å±¤ï¼Œè¼¸å‡ºå‰æœƒä¸€ä½µåˆæˆ -->
          <div id="stickerLayer" class="overlay hidden"></div>
        </div>
      </section>

      <!-- å³ï¼šç´ æèˆ‡è¨­å®š -->
      <aside class="side">
        <section class="card panel">
          <h3 style="margin:6px 0 10px">è²¼åœ–ç´ æï¼ˆé»ä¸€ä¸‹åŠ å…¥ï¼‰</h3>
          <div class="stickers" id="stickerPalette">
            <!-- ç°¡å–® SVG è²¼åœ–ï¼Œé»æ“ŠåŠ å…¥åˆ°ç•«é¢ï¼Œå¯æ‹–ç§» -->
            <div class="sticker" data-svg="ball" title="æ£’çƒ">
              âš¾
            </div>
            <div class="sticker" data-svg="bat" title="çƒæ£’">
              ğŸ¦¾
            </div>
            <div class="sticker" data-svg="capT" title="T éšŠå¸½">
              ğŸ§¢
            </div>
            <div class="sticker" data-svg="mvp" title="MVP å¾½ç« ">
              â­
            </div>
            <div class="sticker" data-svg="cheer" title="CHEER æ©«å¹…">
              ğŸ“£
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnClearStickers" class="danger">æ¸…ç©ºè²¼åœ–</button>
          </div>
        </section>

        <section class="card panel">
          <h3 style="margin:6px 0 10px">ç›¸æ¡†æ¨™é¡Œ</h3>
          <div class="row">
            <input id="titleInput" type="text" value="TAIWAN BASEBALL NIGHT" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:#fff"/>
            <button id="btnApplyTitle">å¥—ç”¨</button>
          </div>
          <p class="hint">ä¹Ÿå¯æ”¹å³ä¸‹è§’éšŠå¾½å­—æ¯ï¼š<input id="badgeInput" type="text" value="T" maxlength="2" style="width:48px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:#fff; margin-left:6px"></p>
        </section>

        <section class="card panel">
          <h3 style="margin:6px 0 10px">èªªæ˜</h3>
          <ol style="margin:0 0 4px 18px; line-height:1.7">
            <li>æŒ‰ã€Œå•Ÿå‹•é¡é ­ã€ï¼Œå…è¨±ä½¿ç”¨ç›¸æ©Ÿï¼ˆéœ€ HTTPS æˆ–æœ¬æ©Ÿï¼‰ã€‚</li>
            <li>æ‹–æ›³è²¼åœ–åˆ°å–æ™¯ç•«é¢ï¼Œèª¿æ•´ä½ç½®ã€‚</li>
            <li>å¯åˆ‡æ›å‰ï¼å¾Œé¡é ­ã€é¡åƒã€å€’æ•¸ã€‚</li>
            <li>æŒ‰ã€Œæ‹ç…§ã€â†’ æª¢æŸ¥ â†’ ä¸‹è¼‰ PNGã€‚</li>
            <li>å°‡æœ¬æª”ä¸Šå‚³åˆ° GitHub Pages / Netlify / Vercel å³å¯ä½¿ç”¨ã€‚</li>
          </ol>
        </section>
      </aside>
    </div>

    <div class="footer">Â© 2025 Polaroid Baseball â€“ å…¨å‰ç«¯è™•ç†ï¼Œä¸ä¸Šå‚³ä»»ä½•å½±åƒåˆ°ä¼ºæœå™¨ã€‚</div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const overlay = document.getElementById('overlay');
    const stage = document.getElementById('stage');
    const stickerLayer = document.getElementById('stickerLayer');

    const btnStart = document.getElementById('btnStart');
    const btnSwitch = document.getElementById('btnSwitch');
    const btnSnap = document.getElementById('btnSnap');
    const btnRetake = document.getElementById('btnRetake');
    const btnDownload = document.getElementById('btnDownload');
    const chkMirror = document.getElementById('chkMirror');
    const chkCountdown = document.getElementById('chkCountdown');
    const frameOpacity = document.getElementById('frameOpacity');

    const titleInput = document.getElementById('titleInput');
    const btnApplyTitle = document.getElementById('btnApplyTitle');
    const badgeInput = document.getElementById('badgeInput');

    const badge = document.getElementById('badge');

    let stream = null;
    let usingFront = true; // true: user (å‰é¡é ­), false: environment (å¾Œé¡é ­)
    let ticking = null;
    let startTime = null;

    function updateBadge(){
      if(!startTime) return;
      const sec = Math.floor((performance.now() - startTime)/1000);
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      badge.textContent = `LIVE\u2006â€¢\u2006${m}:${s}`;
    }

    function raf(){
      updateBadge();
      ticking = requestAnimationFrame(raf);
    }

    function stopRaf(){ if(ticking) cancelAnimationFrame(ticking); }

    async function startCamera(){
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFront ? 'user' : 'environment' },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        startTime = performance.now();
        raf();
      }catch(err){
        alert('é–‹å•Ÿç›¸æ©Ÿå¤±æ•—ï¼š' + err.message + '\nè«‹ç¢ºèªå·²åœ¨ HTTPS æˆ–æœ¬æ©Ÿï¼Œä¸¦å…è¨±ä½¿ç”¨ç›¸æ©Ÿã€‚');
      }
    }

    function switchCamera(){
      usingFront = !usingFront; startCamera();
    }

    chkMirror.addEventListener('change', ()=>{
      video.style.transform = chkMirror.checked ? 'scaleX(-1)' : 'none';
    });
    // åˆå§‹é¡åƒï¼ˆè‡ªæ‹å¸¸ç”¨ï¼‰
    video.style.transform = 'scaleX(-1)';

    frameOpacity.addEventListener('input', ()=>{
      overlay.style.opacity = (frameOpacity.value/100).toString();
    });
    overlay.style.opacity = (frameOpacity.value/100).toString();

    btnStart.addEventListener('click', startCamera);
    btnSwitch.addEventListener('click', switchCamera);

    // å‹•æ…‹ä¿®æ”¹ç›¸æ¡†æ¨™é¡Œèˆ‡éšŠå¾½
    btnApplyTitle.addEventListener('click', ()=>{
      const svg = overlay.querySelector('svg');
      const titleNode = svg.querySelector('text');
      if(titleNode) titleNode.textContent = titleInput.value || '';
      const emblem = svg.querySelector('g[transform="translate(980,760)"] text');
      if (emblem) emblem.textContent = (badgeInput.value || 'T').slice(0,2).toUpperCase();
    });

    // å€’æ•¸å·¥å…·
    function countdown(sec=3){
      return new Promise(resolve=>{
        if(!chkCountdown.checked){ resolve(); return; }
        const el = document.createElement('div');
        el.style.position='absolute'; el.style.inset='0'; el.style.display='grid'; el.style.placeItems='center';
        el.style.fontSize='80px'; el.style.fontWeight='900'; el.style.background='rgba(0,0,0,.35)';
        let n = sec;
        el.textContent = n;
        stage.appendChild(el);
        const iv = setInterval(()=>{
          n--; if(n<=0){ clearInterval(iv); stage.removeChild(el); resolve(); }
          else el.textContent = n;
        },1000);
      });
    }

    // ç”¢ç”Ÿæ‹ç…§è¼¸å‡º
    async function snap(){
      if(!video.srcObject){ alert('è«‹å…ˆå•Ÿå‹•é¡é ­'); return; }
      await countdown(3);
      const rect = stage.getBoundingClientRect();
      const w = Math.round(rect.width * devicePixelRatio);
      const h = Math.round(rect.height * devicePixelRatio);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');

      // è¦–è¨Šåˆ°ç•«å¸ƒ
      // è¨ˆç®—é¡åƒèˆ‡ç¸®æ”¾
      ctx.save();
      if(chkMirror.checked){
        ctx.translate(w,0); ctx.scale(-1,1);
      }
      // å°‡ video ç•«åˆ° canvasï¼Œç¶­æŒ cover æ•ˆæœ
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      const arVideo = vw/vh;
      const arCanvas = w/h;
      let dw, dh, dx, dy;
      if(arVideo > arCanvas){ // è¦–è¨Šè¼ƒå¯¬
        dh = h; dw = dh * arVideo; dx = (w - dw)/2; dy = 0;
      }else{ // è¦–è¨Šè¼ƒé«˜
        dw = w; dh = dw / arVideo; dx = 0; dy = (h - dh)/2;
      }
      ctx.drawImage(video, dx, dy, dw, dh);
      ctx.restore();

      // ç–Šä¸Šè²¼åœ–ï¼ˆå¯æ‹–æ›³ï¼‰
      await drawStickerLayerToCanvas(ctx, w, h);

      // ç–Šä¸Šç›¸æ¡†ï¼ˆä»¥ç›®å‰ overlay SVG è½‰ç‚ºå½±åƒï¼‰
      await drawOverlayToCanvas(ctx, w, h);

      // é¡¯ç¤ºå¿«ç…§
      canvas.classList.remove('hidden');
      stickerLayer.classList.remove('hidden');
      btnRetake.classList.remove('hidden');
      btnDownload.classList.remove('hidden');
    }

    btnSnap.addEventListener('click', snap);

    // é‡æ‹
    btnRetake.addEventListener('click', ()=>{
      canvas.classList.add('hidden');
      btnRetake.classList.add('hidden');
      btnDownload.classList.add('hidden');
    });

    // ä¸‹è¼‰
    btnDownload.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = `baseball-polaroid-${Date.now()}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    });

    // ---- å°‡ overlay SVG è½‰åœ–ä¸¦ç•«åˆ° canvas ----
    function svgToDataURL(svgEl){
      const s = new XMLSerializer().serializeToString(svgEl);
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(s);
    }

    function drawImageElement(ctx, img, w, h){
      return new Promise(res=>{ img.onload = ()=>{ ctx.globalAlpha = parseFloat(getComputedStyle(overlay).opacity); ctx.drawImage(img, 0, 0, w, h); ctx.globalAlpha = 1; res(); }; img.onerror=res; });
    }

    async function drawOverlayToCanvas(ctx, w, h){
      const svg = overlay.querySelector('svg');
      const img = new Image();
      img.src = svgToDataURL(svg);
      await drawImageElement(ctx, img, w, h);
    }

    // ---- è²¼åœ–ç³»çµ±ï¼šé»é¸åŠ å…¥ã€å¯æ‹–æ›³ã€åˆæˆè¼¸å‡º ----
    const palette = document.getElementById('stickerPalette');
    const btnClear = document.getElementById('btnClearStickers');

    const SVGs = {
      ball: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='120' height='120'>
        <circle cx='60' cy='60' r='56' fill='white' stroke='#e5e5e5' stroke-width='4'/>
        <path d='M28,18 C44,36 44,84 28,102' stroke='#d23a3a' stroke-width='5' fill='none' stroke-linecap='round'/>
        <path d='M92,18 C76,36 76,84 92,102' stroke='#d23a3a' stroke-width='5' fill='none' stroke-linecap='round'/>
        <g stroke='#d23a3a' stroke-width='5' stroke-linecap='round'>
          <path d='M35,30 l18,-8'/><path d='M35,46 l18,-8'/><path d='M35,62 l18,-8'/><path d='M35,78 l18,-8'/><path d='M35,94 l18,-8'/>
          <path d='M85,30 l-18,-8'/><path d='M85,46 l-18,-8'/><path d='M85,62 l-18,-8'/><path d='M85,78 l-18,-8'/><path d='M85,94 l-18,-8'/>
        </g>
      </svg>`,
      bat: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60' width='200' height='60'>
        <rect x='10' y='22' rx='8' ry='8' width='160' height='16' fill='#b07d47' stroke='#8d6336' stroke-width='3'/>
        <rect x='160' y='18' rx='6' ry='6' width='28' height='24' fill='#272a33'/>
      </svg>`,
      capT: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 140 90' width='140' height='90'>
        <path d='M10,70 q60,-80 120,0 z' fill='#1b2a4b' stroke='#0e1733' stroke-width='4'/>
        <rect x='60' y='62' width='60' height='10' rx='5' fill='#0e1733' />
        <text x='70' y='55' text-anchor='middle' font-size='42' font-family='Segoe UI, Arial' fill='#fff' font-weight='800'>T</text>
      </svg>`,
      mvp: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='120' height='120'>
        <circle cx='60' cy='60' r='50' fill='#ffd95c' stroke='#e6b700' stroke-width='6'/>
        <text x='60' y='72' text-anchor='middle' font-size='40' font-family='Segoe UI, Arial' fill='#1b2a4b' font-weight='900'>MVP</text>
      </svg>`,
      cheer: `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 260 80' width='260' height='80'>
        <rect x='4' y='8' rx='12' ry='12' width='252' height='64' fill='#ff4d6d'/>
        <text x='130' y='56' text-anchor='middle' font-size='42' font-family='Segoe UI, Arial' fill='#fff' font-weight='900'>CHEER</text>
      </svg>`
    };

    palette.addEventListener('click', (e)=>{
      const item = e.target.closest('.sticker');
      if(!item) return;
      const key = item.getAttribute('data-svg');
      const wrap = document.createElement('div');
      wrap.className = 'draggable';
      wrap.innerHTML = SVGs[key] || '';
      wrap.style.width = '160px';
      wrap.style.touchAction = 'none';
      stage.appendChild(wrap);
      enableDrag(wrap);
    });

    btnClear.addEventListener('click', ()=>{
      stage.querySelectorAll('.draggable').forEach(n=>n.remove());
    });

    function enableDrag(el){
      let startX=0, startY=0, origX=0, origY=0, dragging=false;
      function pos(clientX, clientY){ return { x: clientX, y: clientY }; }
      function onDown(ev){
        dragging=true; el.style.cursor='grabbing';
        const p = (ev.touches? ev.touches[0]: ev);
        startX = p.clientX; startY = p.clientY;
        const r = el.getBoundingClientRect();
        const parent = stage.getBoundingClientRect();
        origX = r.left - parent.left; origY = r.top - parent.top;
        ev.preventDefault();
      }
      function onMove(ev){ if(!dragging) return; const p=(ev.touches? ev.touches[0]: ev);
        const dx = p.clientX - startX; const dy = p.clientY - startY;
        el.style.left = (origX + dx) + 'px'; el.style.top = (origY + dy) + 'px';
      }
      function onUp(){ dragging=false; el.style.cursor='move'; }
      el.addEventListener('mousedown', onDown); document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
      el.addEventListener('touchstart', onDown, {passive:false}); document.addEventListener('touchmove', onMove, {passive:false}); document.addEventListener('touchend', onUp);
    }

    // å°‡èˆå°ä¸Šçš„è²¼åœ–ï¼ˆ.draggableï¼‰ä»¥ç›®å‰ç•«é¢ä½ç½®åˆæˆåˆ° canvas
    async function drawStickerLayerToCanvas(ctx, w, h){
      const nodes = Array.from(stage.querySelectorAll('.draggable'));
      for(const el of nodes){
        // å°‡ DOM å…§çš„ SVG è½‰æˆå½±åƒï¼Œå†ä¾æ“šå…¶åœ¨èˆå°çš„åƒç´ ä½ç½®ç¹ªè£½
        const svg = el.querySelector('svg');
        if(!svg) continue;
        const r = el.getBoundingClientRect();
        const parent = stage.getBoundingClientRect();
        const x = (r.left - parent.left) * devicePixelRatio;
        const y = (r.top - parent.top) * devicePixelRatio;
        const wEl = r.width * devicePixelRatio;
        const hEl = r.height * devicePixelRatio;
        const img = new Image();
        img.src = svgToDataURL(svg);
        await new Promise(res=>{ img.onload=()=>{ ctx.drawImage(img, x, y, wEl, hEl); res(); }; img.onerror=res; });
      }
    }

    // åˆå§‹å°‡ stickerLayer ç”¨ä¸åˆ°ï¼Œä¿ç•™ä»¥ä¾¿æ“´å……ï¼ˆä¾‹å¦‚æ‹å¾Œå†èª¿æ•´ï¼‰

    // å•Ÿå‹•å¾Œè‡ªå‹•èª¿æ•´ video å°ºå¯¸æ¯”ä¾‹ï¼ˆCSS å·²åš coverï¼Œé€™è£¡ä¿ç•™é‰¤å­ï¼‰
  </script>
</body>
</html>
